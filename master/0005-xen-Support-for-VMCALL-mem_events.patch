From db4ff8a0946e40191c7feb7497c32f3d5455bdc7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Mihai=20Don=C8=9Bu?= <mdontu@bitdefender.com>
Date: Tue, 15 Sep 2015 10:59:43 +0300
Subject: [PATCH 5/6] xen: Support for VMCALL mem_events

Added support for VMCALL events (the memory introspection library
will have the guest trigger VMCALLs, which will then be sent along
via the mem_event mechanism).

Signed-off-by: Razvan Cojocaru <rcojocaru@bitdefender.com>
---
 xen/arch/x86/hvm/vmx/vmx.c | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/xen/arch/x86/hvm/vmx/vmx.c b/xen/arch/x86/hvm/vmx/vmx.c
index ace0d4a..76f39fb 100644
--- a/xen/arch/x86/hvm/vmx/vmx.c
+++ b/xen/arch/x86/hvm/vmx/vmx.c
@@ -3214,7 +3214,16 @@ void vmx_vmexit_handler(struct cpu_user_regs *regs)
     {
         int rc;
         HVMTRACE_1D(VMMCALL, regs->eax);
-        rc = hvm_do_hypercall(regs);
+
+        if ( regs->eax != 0x494E5452 || !v->domain->arch.monitor.guest_request_enabled )
+            rc = hvm_do_hypercall(regs);
+        else
+        {
+            hvm_event_guest_request();
+            update_guest_eip();
+            break;
+        }
+
         if ( rc != HVM_HCALL_preempted )
         {
             update_guest_eip(); /* Safe: VMCALL */
-- 
2.5.2

